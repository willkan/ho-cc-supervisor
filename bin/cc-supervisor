#!/usr/bin/env node

/**
 * CC-Supervisor CLI
 * Claude Code Supervisor - AI-powered code quality verification
 */

const { program } = require('commander');
const path = require('path');
const fs = require('fs');
const { execSync, spawn } = require('child_process');
const packageJson = require('../package.json');

// è·å–åŒ…çš„å®‰è£…è·¯å¾„ï¼ˆç”¨äºå®šä½éªŒè¯å™¨ï¼‰
const PACKAGE_ROOT = path.join(__dirname, '..');

// è®¾ç½®ç‰ˆæœ¬å’Œæè¿°
program
  .name('cc-supervisor')
  .description('Claude Code Supervisor - AI-powered code quality verification')
  .version(packageJson.version);

// verify å‘½ä»¤ - æ‰§è¡ŒéªŒè¯ï¼ˆä¾› hook è°ƒç”¨ï¼‰
program
  .command('verify')
  .description('æ‰§è¡ŒéªŒè¯ï¼ˆç”± Stop hook è°ƒç”¨ï¼‰')
  .option('--json', 'è¾“å‡ºJSONæ ¼å¼ç”¨äºhooké›†æˆ')
  .option('--silent', 'é™é»˜æ¨¡å¼ï¼Œåªè¾“å‡ºç»“æœ')
  .option('--session <id>', 'Session ID (passed by cc-supervisor-claude)')
  .action(async (options) => {
    const verifierPath = path.join(PACKAGE_ROOT, 'lib', 'claude-verify-simple.js');
    
    if (!fs.existsSync(verifierPath)) {
      if (options.json) {
        console.log(JSON.stringify({
          continue: true,
          systemMessage: "éªŒè¯å™¨æœªæ‰¾åˆ°"
        }));
      } else {
        console.error('âŒ éªŒè¯å™¨æœªæ‰¾åˆ°');
      }
      process.exit(1);
    }
    
    // è®¾ç½®ç¯å¢ƒå˜é‡é˜²æ­¢å¾ªç¯
    if (process.env.CLAUDE_VERIFIER_MODE === 'true') {
      if (options.json) {
        console.log(JSON.stringify({ continue: true }));
      } else if (!options.silent) {
        console.log('â­ï¸  éªŒè¯ Claude ä¸è§¦å‘éªŒè¯');
      }
      process.exit(0);
    }
    
    // ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
    const logsDir = path.join(process.cwd(), 'logs/cc-supervisor/completions');
    fs.mkdirSync(logsDir, { recursive: true });
    
    // è®°å½•æ—¥å¿—
    const logFile = path.join(logsDir, 'stop.log');
    const timestamp = new Date().toISOString().replace('T', ' ').split('.')[0];
    fs.appendFileSync(logFile, `[${timestamp}] Stop hook triggered\n`);
    fs.appendFileSync(logFile, 'ğŸ¤– å¯åŠ¨ Claude æ™ºèƒ½éªŒè¯ (claude -p æ¨¡å¼)...\n');
    
    // è¿è¡ŒéªŒè¯å™¨
    try {
      const SimpleClaudeVerifier = require(verifierPath);
      const verifier = new SimpleClaudeVerifier({ projectRoot: process.cwd() });
      const result = await verifier.verify();
      
      // æ„å»ºå®Œæ•´çš„éªŒè¯åé¦ˆå†…å®¹
      const fullMessage = `ğŸ“‹ éªŒè¯åé¦ˆ:\n${result.response || 'éªŒè¯å®Œæˆ'}\n${!result.success ? 'âš ï¸ å»ºè®®æ£€æŸ¥å¹¶ä¿®å¤ä¸Šè¿°é—®é¢˜' : 'âœ… ä»£ç è´¨é‡è‰¯å¥½'}`;
      
      // å°†å®Œæ•´ç»“æœè®°å½•åˆ°æ—¥å¿—ï¼ˆåŒ…æ‹¬æ‰€æœ‰ç»†èŠ‚ï¼‰
      fs.appendFileSync(logFile, '--- éªŒè¯ç»“æœå¼€å§‹ ---\n');
      fs.appendFileSync(logFile, fullMessage + '\n');
      fs.appendFileSync(logFile, '--- éªŒè¯ç»“æœç»“æŸ ---\n');
      
      // åŒæ—¶ä¿å­˜åˆ°ç‹¬ç«‹çš„è¯¦ç»†æ—¥å¿—æ–‡ä»¶
      const detailedLogFile = path.join(logsDir, `verification-${Date.now()}.log`);
      fs.writeFileSync(detailedLogFile, fullMessage);
      
      // å†™å…¥ issues æ–‡ä»¶ä¾› supervisor-node æ£€æµ‹
      // æ›´æ™ºèƒ½çš„æ£€æµ‹ï¼šåŒ…å«"é—®é¢˜"æˆ–æœ‰å®è´¨æ€§"å»ºè®®"æ—¶éƒ½å†™å…¥
      const hasActionableContent = result.response && (
        result.response.includes('é—®é¢˜:') && !result.response.includes('é—®é¢˜: -') || // æœ‰å®é™…é—®é¢˜
        result.response.includes('å»ºè®®:') && !result.response.includes('å»ºè®®: -') || // æœ‰å®é™…å»ºè®®
        result.response.includes('éœ€è¦ä¿®å¤') ||
        result.response.includes('éœ€è¦æ”¹è¿›') ||
        result.response.includes('é”™è¯¯') ||
        result.response.includes('å¤±è´¥') ||
        !result.success
      );
      
      if (hasActionableContent) {
        // è·å–é¡¹ç›®è·¯å¾„å’Œ session ID
        const projectPath = process.cwd();
        const projectName = projectPath.replace(/\//g, '-').replace(/^-/, '');
        const supervisorDir = path.join(require('os').homedir(), '.cc-supervisor', 'projects', projectName);
        
        // ä¼˜å…ˆä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ä¸­çš„ session IDï¼Œå…¶æ¬¡ä½¿ç”¨ç¯å¢ƒå˜é‡
        const sessionId = options.session || process.env.SUPERVISOR_SESSION_ID;
        
        if (sessionId) {
          // ç¡®ä¿ç›®å½•å­˜åœ¨
          fs.mkdirSync(supervisorDir, { recursive: true });
          const issuesFile = path.join(supervisorDir, `${sessionId}.issues`);
          
          // å†™å…¥é—®é¢˜æ–‡ä»¶
          const issueMessage = `ğŸ”§ å‘ç°ä»¥ä¸‹é—®é¢˜éœ€è¦ä¿®å¤:\n\n${result.response}\n\nè¯·æ ¹æ®ä¸Šè¿°åé¦ˆä¿®å¤ä»£ç é—®é¢˜ã€‚`;
          fs.writeFileSync(issuesFile, issueMessage);
          fs.appendFileSync(logFile, `âœï¸ é—®é¢˜å·²å†™å…¥: ${issuesFile}\n`);
        }
      }
      
      if (options.json) {
        // JSON æ ¼å¼è¾“å‡ºï¼Œç”¨äº hook é›†æˆ
        // Stop hook ä½¿ç”¨ systemMessage è€Œä¸æ˜¯ hookSpecificOutput
        const output = {
          continue: true,
          systemMessage: fullMessage
        };
        console.log(JSON.stringify(output));
        
      } else {
        // äººç±»å¯è¯»æ ¼å¼
        if (!result.success) {
          // éªŒè¯å¤±è´¥æ—¶è¾“å‡ºåˆ° stderrï¼Œexit code 2
          // è¿™ä¼šè®© Claude Code è‡ªåŠ¨å°†åé¦ˆä¼ é€’ç»™ Worker Claude
          console.error('\nâŒ éªŒè¯å‘ç°é—®é¢˜éœ€è¦å¤„ç†ï¼š\n');
          console.error(result.response || 'éªŒè¯å¤±è´¥');
          console.error('\nè¯·æ£€æŸ¥å¹¶ä¿®å¤ä¸Šè¿°é—®é¢˜');
          process.exit(2); // exit code 2 ä¼šè®© stderr è‡ªåŠ¨åé¦ˆç»™ Claude
        } else {
          // éªŒè¯æˆåŠŸï¼Œæ­£å¸¸è¾“å‡º
          console.log('\nâœ… éªŒè¯é€šè¿‡');
          console.log(`\n${result.response || 'ä»£ç è´¨é‡è‰¯å¥½'}`);
        }
      }
      
    } catch (error) {
      if (options.json) {
        console.log(JSON.stringify({
          continue: false,
          systemMessage: `éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}`
        }));
      } else {
        console.error('âŒ éªŒè¯å¤±è´¥:', error.message);
      }
      // è®°å½•é”™è¯¯åˆ°æ—¥å¿—
      fs.appendFileSync(logFile, `âŒ éªŒè¯å¤±è´¥: ${error.message}\n`);
      process.exit(1);
    }
  });

// init å‘½ä»¤ - åˆå§‹åŒ–é¡¹ç›®
program
  .command('init')
  .description('åœ¨å½“å‰é¡¹ç›®ä¸­åˆå§‹åŒ– CC-Supervisor')
  .option('-f, --force', 'å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„é…ç½®')
  .action((options) => {
    const targetDir = process.cwd();
    const sourceDir = path.join(__dirname, '..');
    
    console.log('ğŸš€ åˆå§‹åŒ– CC-Supervisor...');
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é…ç½®
    const claudeDir = path.join(targetDir, '.claude');
    const settingsPath = path.join(claudeDir, 'settings.json');
    const hasExistingConfig = fs.existsSync(settingsPath);
    
    try {
      // 1. å¤„ç† .claude/settings.json
      if (hasExistingConfig && !options.force) {
        console.log('ğŸ“‹ æ£€æµ‹åˆ°ç°æœ‰ hooks é…ç½®ï¼Œæ™ºèƒ½åˆå¹¶ä¸­...');
        
        // å¤‡ä»½åŸé…ç½®
        const backupPath = settingsPath + '.backup.' + Date.now();
        fs.copyFileSync(settingsPath, backupPath);
        console.log(`   å¤‡ä»½åŸé…ç½®åˆ°: ${path.basename(backupPath)}`);
        
        // è¯»å–ç°æœ‰é…ç½®
        const existingConfig = JSON.parse(fs.readFileSync(settingsPath, 'utf-8'));
        const supervisorConfig = JSON.parse(fs.readFileSync(path.join(sourceDir, '.claude/settings.json'), 'utf-8'));
        
        // æ™ºèƒ½åˆå¹¶é…ç½®
        if (!existingConfig.hooks) {
          existingConfig.hooks = {};
        }
        
        // åˆå¹¶ Stop hook
        if (existingConfig.hooks.Stop) {
          console.log('   âš ï¸  å·²å­˜åœ¨ Stop hookï¼Œå°†åˆ›å»º supervisor-stop.sh ä½œä¸ºè¡¥å……');
          // åˆ›å»ºç‹¬ç«‹çš„ supervisor hook
          const supervisorStopPath = path.join(claudeDir, 'hooks', 'supervisor-stop.sh');
          fs.mkdirSync(path.join(claudeDir, 'hooks'), { recursive: true });
          fs.copyFileSync(path.join(sourceDir, '.claude/hooks/stop.sh'), supervisorStopPath);
          console.log('   ğŸ’¡ è¯·æ‰‹åŠ¨åœ¨åŸ Stop hook ä¸­è°ƒç”¨ supervisor-stop.sh');
        } else {
          existingConfig.hooks.Stop = supervisorConfig.hooks.Stop;
          console.log('   âœ… æ·»åŠ  Stop hook');
        }
        
        // åˆå¹¶ PostToolUse hooks
        if (!existingConfig.hooks.PostToolUse) {
          existingConfig.hooks.PostToolUse = {};
        }
        Object.keys(supervisorConfig.hooks.PostToolUse || {}).forEach(tool => {
          if (!existingConfig.hooks.PostToolUse[tool]) {
            existingConfig.hooks.PostToolUse[tool] = supervisorConfig.hooks.PostToolUse[tool];
            console.log(`   âœ… æ·»åŠ  PostToolUse.${tool} hook`);
          } else {
            console.log(`   â­ï¸  è·³è¿‡å·²å­˜åœ¨çš„ PostToolUse.${tool} hook`);
          }
        });
        
        // åˆå¹¶ UserPromptSubmit hook
        if (!existingConfig.hooks.UserPromptSubmit) {
          existingConfig.hooks.UserPromptSubmit = supervisorConfig.hooks.UserPromptSubmit;
          console.log('   âœ… æ·»åŠ  UserPromptSubmit hook');
        } else {
          console.log('   â­ï¸  è·³è¿‡å·²å­˜åœ¨çš„ UserPromptSubmit hook');
        }
        
        // å†™å…¥åˆå¹¶åçš„é…ç½®
        fs.writeFileSync(settingsPath, JSON.stringify(existingConfig, null, 2));
        console.log('âœ… é…ç½®åˆå¹¶å®Œæˆ');
        
      } else if (options.force) {
        // å¼ºåˆ¶è¦†ç›–æ¨¡å¼
        console.log('âš ï¸  å¼ºåˆ¶è¦†ç›–æ¨¡å¼...');
        if (hasExistingConfig) {
          const backupPath = settingsPath + '.backup.' + Date.now();
          fs.copyFileSync(settingsPath, backupPath);
          console.log(`   å¤‡ä»½åŸé…ç½®åˆ°: ${path.basename(backupPath)}`);
        }
        
        // å¤åˆ¶æ•´ä¸ª .claude ç›®å½•
        execSync(`cp -r "${path.join(sourceDir, '.claude')}" "${targetDir}/"`, { stdio: 'pipe' });
        console.log('âœ… é…ç½®å·²è¦†ç›–');
        
      } else {
        // å…¨æ–°å®‰è£…
        console.log('ğŸ“ åˆ›å»º hooks é…ç½®...');
        execSync(`cp -r "${path.join(sourceDir, '.claude')}" "${targetDir}/"`, { stdio: 'pipe' });
      }
      
      // 2. å¤åˆ¶ hook è„šæœ¬ï¼ˆä¸è¦†ç›–å·²å­˜åœ¨çš„ï¼‰
      const hooksDir = path.join(claudeDir, 'hooks');
      fs.mkdirSync(hooksDir, { recursive: true });
      
      const sourceHooks = fs.readdirSync(path.join(sourceDir, '.claude/hooks'));
      sourceHooks.forEach(hook => {
        const targetPath = path.join(hooksDir, hook);
        if (!fs.existsSync(targetPath) || options.force) {
          fs.copyFileSync(path.join(sourceDir, '.claude/hooks', hook), targetPath);
          console.log(`   âœ… å¤åˆ¶ ${hook}`);
        } else {
          console.log(`   â­ï¸  ä¿ç•™ç°æœ‰ ${hook}`);
        }
      });
      
      // 3. ä¸å†å¤åˆ¶ lib æ–‡ä»¶ï¼Œä½¿ç”¨å…¨å±€å®‰è£…çš„ cc-supervisor
      
      // 4. åˆ›å»º logs ç›®å½•
      console.log('ğŸ“ åˆ›å»ºæ—¥å¿—ç›®å½•...');
      execSync(`mkdir -p "${targetDir}/logs/cc-supervisor/completions" "${targetDir}/logs/cc-supervisor/checks" "${targetDir}/logs/cc-supervisor/intents"`, { stdio: 'pipe' });
      
      // 5. è®¾ç½®æ‰§è¡Œæƒé™
      console.log('ğŸ”§ è®¾ç½®è„šæœ¬æƒé™...');
      execSync(`chmod +x "${hooksDir}/"*.sh 2>/dev/null || true`, { stdio: 'pipe' });
      
      // 6. æ›´æ–° hook è„šæœ¬ä½¿ç”¨ CLI å‘½ä»¤
      updateHookScripts(hooksDir);
      
      console.log('âœ… CC-Supervisor åˆå§‹åŒ–æˆåŠŸï¼');
      console.log('');
      
      if (hasExistingConfig && !options.force) {
        console.log('âš ï¸  æ³¨æ„ï¼š');
        console.log('   ç”±äºä½ å·²æœ‰ hooks é…ç½®ï¼Œéƒ¨åˆ† hooks å¯èƒ½éœ€è¦æ‰‹åŠ¨æ•´åˆ');
        console.log('   æŸ¥çœ‹ .claude/settings.json.backup.* äº†è§£åŸé…ç½®');
        console.log('');
      }
      
      console.log('ä¸‹ä¸€æ­¥ï¼š');
      console.log('1. å¯åŠ¨æ–°çš„ Claude Code ä¼šè¯: claude');
      console.log('2. æ­£å¸¸å·¥ä½œï¼ŒéªŒè¯ä¼šè‡ªåŠ¨è¿è¡Œ');
      console.log('3. æŸ¥çœ‹éªŒè¯æŠ¥å‘Š: npx cc-supervisor show-report');
      console.log('4. æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€: npx cc-supervisor status');
      
    } catch (error) {
      console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error.message);
      process.exit(1);
    }
  });

// è¾…åŠ©å‡½æ•°ï¼šæ›´æ–° hook è„šæœ¬ä½¿ç”¨ CLI å‘½ä»¤
function updateHookScripts(hooksDir) {
  // ä¸å†é‡å†™hooksï¼Œä¿æŒä»æºç›®å½•å¤åˆ¶çš„å®Œæ•´ç‰ˆæœ¬
  // è¿™äº›hookså·²ç»åœ¨å‰é¢çš„æ­¥éª¤ä¸­ä» .claude/hooks/ å¤åˆ¶è¿‡æ¥äº†ï¼ŒåŒ…å«å®Œæ•´åŠŸèƒ½
  
  // åªéœ€è¦ç¡®ä¿æƒé™æ­£ç¡®
  const hooks = fs.readdirSync(hooksDir).filter(f => f.endsWith('.sh'));
  hooks.forEach(hook => {
    const hookPath = path.join(hooksDir, hook);
    execSync(`chmod +x "${hookPath}"`);
  });
}

// show-report å‘½ä»¤ - æŸ¥çœ‹éªŒè¯æŠ¥å‘Š
program
  .command('show-report')
  .description('æŸ¥çœ‹éªŒè¯å†å²æŠ¥å‘Š')
  .option('-n, --lines <number>', 'æ˜¾ç¤ºæœ€è¿‘çš„Næ¡è®°å½•', '10')
  .option('-f, --follow', 'å®æ—¶è·Ÿè¸ªæ—¥å¿—')
  .option('--json', 'ä»¥JSONæ ¼å¼è¾“å‡º')
  .option('--detailed', 'æ˜¾ç¤ºè¯¦ç»†çš„éªŒè¯æ—¥å¿—')
  .option('--latest', 'æ˜¾ç¤ºæœ€æ–°çš„å®Œæ•´éªŒè¯ç»“æœ')
  .action((options) => {
    const logsDir = path.join(process.cwd(), 'logs/cc-supervisor');
    
    if (!fs.existsSync(logsDir)) {
      console.error('âŒ æœªæ‰¾åˆ°æ—¥å¿—ç›®å½•ï¼è¯·å…ˆè¿è¡Œ cc-supervisor init');
      process.exit(1);
    }
    
    const logFile = path.join(logsDir, 'completions', 'stop.log');
    
    if (!fs.existsSync(logFile) && !options.latest && !options.detailed) {
      console.log('ğŸ“‹ æš‚æ— éªŒè¯è®°å½•');
      return;
    }
    
    // æ˜¾ç¤ºæœ€æ–°çš„å®Œæ•´éªŒè¯ç»“æœ
    if (options.latest) {
      const verificationFiles = fs.readdirSync(logsDir)
        .filter(file => file.startsWith('verification-') && file.endsWith('.log'))
        .sort((a, b) => {
          const timeA = parseInt(a.match(/verification-(\d+)\.log/)[1]);
          const timeB = parseInt(b.match(/verification-(\d+)\.log/)[1]);
          return timeB - timeA;
        });
      
      if (verificationFiles.length === 0) {
        console.log('ğŸ“‹ æš‚æ— è¯¦ç»†éªŒè¯è®°å½•');
        return;
      }
      
      const latestFile = path.join(logsDir, verificationFiles[0]);
      const content = fs.readFileSync(latestFile, 'utf-8');
      
      console.log('ğŸ“‹ æœ€æ–°éªŒè¯ç»“æœï¼ˆå®Œæ•´ç‰ˆï¼‰\n');
      console.log('â•'.repeat(60));
      console.log(content);
      console.log('â•'.repeat(60));
      
      const timestamp = new Date(parseInt(verificationFiles[0].match(/verification-(\d+)\.log/)[1]));
      console.log(`\nğŸ• éªŒè¯æ—¶é—´: ${timestamp.toLocaleString()}`);
      return;
    }
    
    // æ˜¾ç¤ºè¯¦ç»†çš„éªŒè¯è®°å½•
    if (options.detailed) {
      const content = fs.readFileSync(logFile, 'utf-8');
      const sections = content.split('--- éªŒè¯ç»“æœå¼€å§‹ ---');
      
      if (sections.length <= 1) {
        console.log('ğŸ“‹ æš‚æ— è¯¦ç»†éªŒè¯è®°å½•ï¼ˆè¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰');
        return;
      }
      
      console.log('ğŸ“‹ è¯¦ç»†éªŒè¯å†å²\n');
      console.log('â•'.repeat(60));
      
      // æ˜¾ç¤ºæœ€è¿‘çš„å‡ æ¡è¯¦ç»†è®°å½•
      const detailedRecords = sections.slice(-Math.min(sections.length - 1, parseInt(options.lines)));
      
      detailedRecords.forEach((section, index) => {
        if (section.includes('--- éªŒè¯ç»“æœç»“æŸ ---')) {
          const result = section.split('--- éªŒè¯ç»“æœç»“æŸ ---')[0];
          if (index > 0) console.log('\n' + 'â”€'.repeat(60) + '\n');
          console.log(result.trim());
        }
      });
      
      console.log('\n' + 'â•'.repeat(60));
      return;
    }
    
    if (options.follow) {
      // å®æ—¶è·Ÿè¸ªæ¨¡å¼
      console.log('ğŸ“‹ å®æ—¶ç›‘æ§éªŒè¯æ—¥å¿— (Ctrl+C é€€å‡º)...\n');
      const tail = spawn('tail', ['-f', logFile]);
      tail.stdout.pipe(process.stdout);
      tail.stderr.pipe(process.stderr);
      
      process.on('SIGINT', () => {
        tail.kill();
        process.exit(0);
      });
    } else if (options.json) {
      // JSON è¾“å‡ºæ¨¡å¼
      const content = fs.readFileSync(logFile, 'utf-8');
      const records = parseLogRecords(content);
      console.log(JSON.stringify(records.slice(-options.lines), null, 2));
    } else {
      // æ™®é€šæŸ¥çœ‹æ¨¡å¼
      console.log('ğŸ“‹ éªŒè¯å†å²æŠ¥å‘Š\n');
      console.log('â”€'.repeat(60));
      
      const content = fs.readFileSync(logFile, 'utf-8');
      const lines = content.split('\n').filter(line => line.trim());
      const recent = lines.slice(-options.lines);
      
      let currentSession = null;
      recent.forEach(line => {
        // ç¾åŒ–è¾“å‡º
        if (line.includes('Stop hook triggered')) {
          if (currentSession) console.log(''); // æ·»åŠ ç©ºè¡Œåˆ†éš”
          console.log(`ğŸ” ${line}`);
          currentSession = line;
        } else if (line.includes('éªŒè¯ç»“æœ:')) {
          console.log(`   âœ… ${line.replace('ğŸ“‹ ', '')}`);
        } else if (line.includes('éªŒè¯å¤±è´¥:')) {
          console.log(`   âŒ ${line}`);
        } else if (line.includes('å¯åŠ¨ Claude æ™ºèƒ½éªŒè¯')) {
          console.log(`   ğŸ¤– å¯åŠ¨éªŒè¯ä¸­...`);
        } else if (line.includes('[è·³è¿‡]')) {
          console.log(`   â­ï¸  ${line}`);
        } else if (line.trim()) {
          console.log(`   ${line}`);
        }
      });
      
      console.log('\n' + 'â”€'.repeat(60));
      console.log(`\nğŸ’¡ æç¤º: ä½¿ç”¨ --follow å®æ—¶æŸ¥çœ‹ | ä½¿ç”¨ --json è¾“å‡ºJSONæ ¼å¼`);
    }
  });

// status å‘½ä»¤ - æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
program
  .command('status')
  .description('æŸ¥çœ‹ CC-Supervisor çŠ¶æ€')
  .action(() => {
    const claudeDir = path.join(process.cwd(), '.claude');
    const logsDir = path.join(process.cwd(), 'logs/cc-supervisor');
    
    console.log('ğŸ” CC-Supervisor ç³»ç»ŸçŠ¶æ€\n');
    console.log('â”€'.repeat(60));
    
    // æ£€æŸ¥å®‰è£…çŠ¶æ€
    const isInstalled = fs.existsSync(claudeDir) && fs.existsSync(path.join(claudeDir, 'settings.json'));
    console.log(`ğŸ“¦ å®‰è£…çŠ¶æ€: ${isInstalled ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}`);
    
    if (isInstalled) {
      // æ£€æŸ¥é…ç½®æ–‡ä»¶
      const settingsPath = path.join(claudeDir, 'settings.json');
      const hasSettings = fs.existsSync(settingsPath);
      console.log(`âš™ï¸  é…ç½®æ–‡ä»¶: ${hasSettings ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}`);
      
      // æ£€æŸ¥ hooks
      const hooksDir = path.join(claudeDir, 'hooks');
      if (fs.existsSync(hooksDir)) {
        const hooks = fs.readdirSync(hooksDir).filter(f => f.endsWith('.sh'));
        console.log(`ğŸª Hooks è„šæœ¬: ${hooks.length} ä¸ª`);
        hooks.forEach(hook => {
          const hookPath = path.join(hooksDir, hook);
          const isExecutable = fs.statSync(hookPath).mode & 0o111;
          console.log(`   - ${hook} ${isExecutable ? 'âœ…' : 'âŒ (éœ€è¦æ‰§è¡Œæƒé™)'}`);
        });
      }
      
      // æ£€æŸ¥éªŒè¯å™¨ï¼ˆç°åœ¨æ˜¯å…¨å±€å®‰è£…çš„ï¼‰
      console.log(`ğŸ¤– éªŒè¯å™¨: âœ… cc-supervisor verify (å…¨å±€å‘½ä»¤)`);
      
      // ç»Ÿè®¡æ—¥å¿—
      if (fs.existsSync(logsDir)) {
        const logFile = path.join(logsDir, 'completions', 'stop.log');
        if (fs.existsSync(logFile)) {
          const content = fs.readFileSync(logFile, 'utf-8');
          const verifications = content.split('\n').filter(line => line.includes('Stop hook triggered')).length;
          const lastLines = content.split('\n').filter(l => l.trim()).slice(-3);
          console.log(`ğŸ“Š éªŒè¯æ¬¡æ•°: ${verifications} æ¬¡`);
          if (lastLines.length > 0) {
            console.log(`ğŸ“ æœ€è¿‘éªŒè¯:`);
            lastLines.forEach(line => {
              if (line.includes('éªŒè¯ Claude åé¦ˆ')) {
                console.log(`   ${line.substring(line.indexOf('éªŒè¯ Claude åé¦ˆ'))}`);
              }
            });
          }
        } else {
          console.log(`ğŸ“Š éªŒè¯æ¬¡æ•°: 0 æ¬¡`);
        }
      }
    }
    
    console.log('â”€'.repeat(60));
    
    if (!isInstalled) {
      console.log('\nğŸ’¡ è¿è¡Œ cc-supervisor init æ¥åˆå§‹åŒ–');
    } else {
      console.log('\nâœ¨ ç³»ç»Ÿå°±ç»ªï¼å¯åŠ¨ Claude Code å³å¯ä½¿ç”¨');
    }
  });

// show-prompts å‘½ä»¤ - æŸ¥çœ‹ Supervisor çš„éªŒè¯æç¤ºå†å²
program
  .command('show-prompts')
  .description('æŸ¥çœ‹ Supervisor Claude çš„éªŒè¯æç¤ºå†å²')
  .option('-n, --lines <number>', 'æ˜¾ç¤ºæœ€è¿‘çš„Næ¡è®°å½•', '5')
  .option('--latest', 'æ˜¾ç¤ºæœ€æ–°çš„å®Œæ•´æç¤º')
  .action((options) => {
    const promptsDir = path.join(process.cwd(), 'logs/cc-supervisor/prompts');
    
    if (!fs.existsSync(promptsDir)) {
      console.log('ğŸ“‹ æš‚æ— éªŒè¯æç¤ºå†å²');
      return;
    }
    
    const promptFiles = fs.readdirSync(promptsDir)
      .filter(f => f.startsWith('prompt-') && f.endsWith('.txt'))
      .sort((a, b) => {
        const timeA = parseInt(a.match(/prompt-(\d+)\.txt/)[1]);
        const timeB = parseInt(b.match(/prompt-(\d+)\.txt/)[1]);
        return timeB - timeA;
      });
    
    if (promptFiles.length === 0) {
      console.log('ğŸ“‹ æš‚æ— éªŒè¯æç¤ºå†å²');
      return;
    }
    
    if (options.latest) {
      // æ˜¾ç¤ºæœ€æ–°çš„å®Œæ•´æç¤º
      const latestFile = path.join(promptsDir, promptFiles[0]);
      const content = fs.readFileSync(latestFile, 'utf-8');
      
      console.log('ğŸ“‹ æœ€æ–°çš„ Supervisor éªŒè¯æç¤º\n');
      console.log('â•'.repeat(60));
      console.log(content);
      console.log('â•'.repeat(60));
    } else {
      // æ˜¾ç¤ºåˆ—è¡¨
      const count = Math.min(promptFiles.length, parseInt(options.lines));
      
      console.log('ğŸ“‹ Supervisor éªŒè¯æç¤ºå†å²\n');
      console.log('â•'.repeat(60));
      
      for (let i = 0; i < count; i++) {
        const file = promptFiles[i];
        const filePath = path.join(promptsDir, file);
        const content = fs.readFileSync(filePath, 'utf-8');
        const firstLine = content.split('\n')[0];
        const timestamp = firstLine.match(/\[(.*?)\]/)[1];
        
        console.log(`\n${i + 1}. ${timestamp}`);
        console.log(`   æ–‡ä»¶: ${file}`);
        
        // æ˜¾ç¤ºå‰å‡ è¡Œå†…å®¹é¢„è§ˆ
        const preview = content.split('\n').slice(2, 5).join('\n');
        console.log(`   é¢„è§ˆ: ${preview.substring(0, 100)}...`);
      }
      
      console.log('\n' + 'â•'.repeat(60));
      console.log(`\nğŸ’¡ ä½¿ç”¨ --latest æŸ¥çœ‹æœ€æ–°çš„å®Œæ•´æç¤º`);
      console.log(`ğŸ’¡ ç›´æ¥æŸ¥çœ‹æ–‡ä»¶: cat logs/cc-supervisor/prompts/prompt-*.txt`);
    }
  });

// clean å‘½ä»¤ - æ¸…ç†æ—¥å¿—
program
  .command('clean')
  .description('æ¸…ç†éªŒè¯æ—¥å¿—')
  .option('--all', 'æ¸…ç†æ‰€æœ‰æ—¥å¿—')
  .action((options) => {
    const logsDir = path.join(process.cwd(), 'logs/cc-supervisor');
    
    if (!fs.existsSync(logsDir)) {
      console.log('ğŸ“‹ æ²¡æœ‰æ—¥å¿—éœ€è¦æ¸…ç†');
      return;
    }
    
    console.log('ğŸ§¹ æ¸…ç†æ—¥å¿—...');
    
    if (options.all) {
      // æ¸…ç†æ‰€æœ‰æ—¥å¿—
      execSync(`rm -rf "${logsDir}"/*`, { stdio: 'pipe' });
      console.log('âœ… æ‰€æœ‰æ—¥å¿—å·²æ¸…ç†');
    } else {
      // åªæ¸…ç†30å¤©å‰çš„æ—¥å¿—
      const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
      cleanOldLogs(logsDir, thirtyDaysAgo);
      console.log('âœ… å·²æ¸…ç†30å¤©å‰çš„æ—¥å¿—');
    }
  });

// test å‘½ä»¤ - æµ‹è¯•éªŒè¯åŠŸèƒ½
program
  .command('test')
  .description('æµ‹è¯•éªŒè¯åŠŸèƒ½')
  .action(() => {
    console.log('ğŸ§ª æµ‹è¯• CC-Supervisor éªŒè¯åŠŸèƒ½...\n');
    
    const testFile = path.join(process.cwd(), 'test-verify.js');
    
    // åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    fs.writeFileSync(testFile, `
function add(a, b) {
  return a + b;
}

console.log('Test file created by cc-supervisor');
`);
    
    console.log('âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶: test-verify.js');
    
    // æ‰‹åŠ¨è§¦å‘éªŒè¯
    const stopHook = path.join(process.cwd(), '.claude/hooks/stop.sh');
    if (fs.existsSync(stopHook)) {
      console.log('ğŸ¤– è§¦å‘éªŒè¯...\n');
      
      try {
        execSync(`bash "${stopHook}"`, { 
          stdio: 'inherit',
          env: { ...process.env, CLAUDE_VERIFIER_MODE: 'false' }
        });
      } catch (error) {
        // éªŒè¯è„šæœ¬å¯èƒ½è¿”å›é0ï¼Œè¿™æ˜¯æ­£å¸¸çš„
      }
    } else {
      console.log('âŒ æœªæ‰¾åˆ°éªŒè¯è„šæœ¬ï¼è¯·å…ˆè¿è¡Œ cc-supervisor init');
    }
    
    // æ¸…ç†æµ‹è¯•æ–‡ä»¶
    fs.unlinkSync(testFile);
    console.log('\nâœ… æµ‹è¯•å®Œæˆï¼Œå·²æ¸…ç†æµ‹è¯•æ–‡ä»¶');
  });

// è¾…åŠ©å‡½æ•°ï¼šè§£ææ—¥å¿—è®°å½•
function parseLogRecords(content) {
  const lines = content.split('\n');
  const records = [];
  let currentRecord = null;
  
  lines.forEach(line => {
    const timestampMatch = line.match(/\[([\d-]+\s[\d:]+)\]/);
    if (timestampMatch) {
      if (currentRecord) {
        records.push(currentRecord);
      }
      currentRecord = {
        timestamp: timestampMatch[1],
        message: line.substring(timestampMatch[0].length).trim(),
        details: []
      };
    } else if (currentRecord && line.trim()) {
      currentRecord.details.push(line.trim());
    }
  });
  
  if (currentRecord) {
    records.push(currentRecord);
  }
  
  return records;
}

// è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†æ—§æ—¥å¿—
function cleanOldLogs(dir, threshold) {
  const files = fs.readdirSync(dir);
  files.forEach(file => {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);
    
    if (stat.isDirectory()) {
      cleanOldLogs(filePath, threshold);
    } else if (stat.isFile() && stat.mtime.getTime() < threshold) {
      fs.unlinkSync(filePath);
    }
  });
}

// è§£æå‘½ä»¤è¡Œå‚æ•°
program.parse(process.argv);

// å¦‚æœæ²¡æœ‰æä¾›å‘½ä»¤ï¼Œæ˜¾ç¤ºå¸®åŠ©
if (!process.argv.slice(2).length) {
  program.outputHelp();
}