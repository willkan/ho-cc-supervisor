# 🔄 Supervisor-ME 完整架构流程图

## 一、核心组件关系

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         用户 (Human Developer)                             │
└────────────────────────────┬─────────────────────────────────────────────┘
                             │ 
                             │ 1. 启动 supervisor-node
                             ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      supervisor-node (透明代理)                            │
│                                                                           │
│  • 透明代理 Claude 的所有输入输出                                           │
│  • 监听 issues 文件变化                                                    │
│  • 检测 Claude 空闲状态                                                    │
│  • 注入修复命令                                                            │
└────────────────┬────────────────────────────────┬───────────────────────┘
                 │ 2. 启动 Claude                 │
                 │    (PTY spawn)                 │ 7. 监听 issues 文件
                 ▼                                ▼
┌──────────────────────────────┐    ┌────────────────────────────────────┐
│    Worker Claude (执行者)     │    │    ~/.supervisor-me/projects/     │
│                               │    │         <project>/                 │
│  • 接收用户任务               │    │    ├── session-1.issues           │
│  • 编写/修改代码              │    │    ├── session-2.issues           │
│  • 接收自动修复命令           │    │    └── active-session             │
└───────────┬───────────────────┘    └─────────▲──────────────────────────┘
            │ 3. 完成任务                      │
            │    触发 Stop Hook                │ 6. 写入 issues 文件
            ▼                                  │
┌──────────────────────────────────────────────┴───────────────────────────┐
│                          Claude Code Hooks                                │
│                                                                           │
│  ┌─────────────────┐  ┌──────────────┐  ┌─────────────────────────────┐ │
│  │ SessionStart    │  │ Stop Hook    │  │ UserPromptSubmit/PostTool   │ │
│  │ • 记录 session  │  │ • 触发验证    │  │ • 记录用户意图和文件修改      │ │
│  │ • 更新 active   │  │ • 获取反馈    │  │ • 辅助信息收集               │ │
│  └─────────────────┘  └──────┬───────┘  └─────────────────────────────┘ │
└───────────────────────────────┼──────────────────────────────────────────┘
                                │ 4. 调用 supervisor-me verify
                                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                     Supervisor Claude (验证者)                             │
│                                                                           │
│  • 使用 claude -p 模式快速验证                                             │
│  • 分析代码质量和完成度                                                    │
│  • 生成结构化反馈                                                         │
│  • 返回验证结果                                                           │
└────────────────────────────┬─────────────────────────────────────────────┘
                             │ 5. 返回验证结果
                             ▼
                    ┌────────────────────┐
                    │ 判断是否有问题？    │
                    └────────┬───────────┘
                             │
                ┌────────────┴────────────┐
                │                         │
                ▼ 有问题                  ▼ 无问题
    ┌───────────────────────┐    ┌──────────────────┐
    │ 写入 issues 文件       │    │ 结束验证循环     │
    │ 触发自动修复           │    │ 等待下次任务     │
    └───────────┬───────────┘    └──────────────────┘
                │ 8. 检测到 issues 文件
                ▼
    ┌───────────────────────────────────┐
    │ supervisor-node 注入修复命令        │
    │ "请分析并修复以下问题：..."         │
    └───────────┬───────────────────────┘
                │ 9. 自动修复
                ▼
    ┌───────────────────────────────────┐
    │ Worker Claude 执行修复              │
    │ • 分析问题                         │
    │ • 修改代码                         │
    │ • 完成后触发新的验证循环            │
    └───────────────────────────────────┘
```

## 二、Session 管理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Session 生命周期管理                              │
└─────────────────────────────────────────────────────────────────────────┘

1. Session 创建/恢复
   ┌────────────┐
   │ claude     │ ──► SessionStart Hook ──► 记录 session_id
   └────────────┘                           更新 active-session

2. Session 识别优先级
   ┌─────────────────────────────────────────────────────────┐
   │ 1. Claude Code 官方 session_id (JSON stdin)            │
   │ 2. 文件系统活跃检测 (5分钟内修改的 .jsonl)              │
   │ 3. supervisor-node 环境变量 (SUPERVISOR_SESSION_ID)     │
   │ 4. 生成新 UUID                                         │
   └─────────────────────────────────────────────────────────┘

3. 多 Session 并行
   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
   │ Terminal 1   │     │ Terminal 2   │     │ Terminal 3   │
   │ session-1    │     │ session-2    │     │ session-3    │
   └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
          │                    │                    │
          ▼                    ▼                    ▼
   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
   │ issues-1     │     │ issues-2     │     │ issues-3     │
   │ 独立验证修复  │     │ 独立验证修复  │     │ 独立验证修复  │
   └──────────────┘     └──────────────┘     └──────────────┘
```

## 三、数据流详解

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据流向图                                     │
└─────────────────────────────────────────────────────────────────────────┘

用户输入 ──────► supervisor-node ──────► Worker Claude
                      ▲                        │
                      │                        │ 输出
                      │                        ▼
                      │                   终端显示
                      │                        │
                      │                        │ Stop Hook
                      │                        ▼
                      │                supervisor-me verify
                      │                        │
                      │                        │ 验证结果
                      │                        ▼
                      │              ┌──────────────────┐
                      │              │ 有问题？         │
                      │              └────┬──────┬──────┘
                      │                   │ Yes  │ No
                      │                   ▼      ▼
                      │            issues 文件   结束
                      │                   │
                      └───────────────────┘
                          自动注入修复命令
```

## 四、文件系统结构

```
文件系统布局
============

~/.claude/projects/<project>/
├── session-1.jsonl              # Claude 会话记录
├── session-2.jsonl              
└── session-3.jsonl              

~/.supervisor-me/projects/<project>/
├── active-session               # 当前活跃 session ID
├── session-history.log          # Session 切换历史
├── session-1.issues             # Session 1 的问题文件
├── session-1.log               # Session 1 的运行日志
├── session-1.history.json      # Session 1 的修复历史
├── session-2.issues            # Session 2 的问题文件
├── session-2.log              # Session 2 的运行日志
└── supervisor.log              # 总体日志

项目目录/.claude/
├── settings.json               # Hooks 配置
└── hooks/
    ├── session-start.sh        # Session 开始 hook
    ├── session-tracker.sh      # Session 追踪器
    ├── stop.sh                # 验证触发 hook
    ├── post-tool-use.sh       # 工具使用 hook
    └── user-prompt-submit.sh  # 用户提示 hook
```

## 五、关键时序

```
时序图：完整的验证-修复循环
========================

User        supervisor-node    Worker Claude    Hooks         Supervisor    Issues File
 │               │                  │             │               │              │
 ├──start────────►                 │             │               │              │
 │               ├──spawn──────────►              │               │              │
 │               │                  ├──session───►│               │              │
 │               │                  │             ├──record────────────────────►│
 ├──task─────────►──forward───────►│             │               │              │
 │               │                  ├──complete──►│               │              │
 │               │                  │             ├──verify──────►│              │
 │               │                  │             │               ├──analyze───►│
 │               │                  │             │               │              │
 │               │                  │             │◄──result──────┤              │
 │               │                  │             ├──issues───────────────────►│
 │               │◄──watch──────────────────────────────────────────────────────┤
 │               ├──inject fix────►│             │               │              │
 │               │                  ├──fix────────────────────────────────────►│
 │               │                  ├──complete──►│               │              │
 │               │                  │             ├──verify──────►│              │
 │               │                  │             │               ├──check────►│
 │               │                  │             │◄──success─────┤              │
 │◄──result──────┤◄─────────────────┤◄────────────┤               │              │
```

## 六、状态机

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    supervisor-node 状态机                                │
└─────────────────────────────────────────────────────────────────────────┘

         ┌─────────┐
         │  INIT   │
         └────┬────┘
              │ 启动 Claude
              ▼
         ┌─────────┐
    ┌────│  IDLE   │◄────┐
    │    └────┬────┘     │
    │         │          │ 完成修复
    │ 检测到  │          │
    │ issues  │          │
    │         ▼          │
    │    ┌─────────┐     │
    │    │ FIXING  ├─────┘
    │    └─────────┘
    │ 
    │ 用户输入
    ▼
┌─────────┐
│ WORKING │
└────┬────┘
     │ 任务完成
     ▼
┌─────────┐
│VERIFYING│
└────┬────┘
     │
     └──► IDLE
```

## 七、核心优势

1. **完全自动化**：无需人工干预的验证-修复循环
2. **透明代理**：保持 Claude 所有原生功能
3. **智能验证**：双 Claude 协作，自然语言理解
4. **Session 隔离**：多开发者/多任务并行不冲突
5. **实时响应**：文件监听 + 空闲检测，快速注入
6. **可扩展性**：Hooks 架构支持自定义扩展

---

*架构版本：v3.0 | 最后更新：2025-08-29*