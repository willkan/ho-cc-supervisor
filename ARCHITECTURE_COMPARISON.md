# Supervisor-ME 架构方案对比

## 方案一：当前双窗口文件监控方案

```ascii
┌─────────────────────────────────────────────────────────────┐
│                     开发者视角                               │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
        ┌──────────────────┐  ┌──────────────────┐
        │   Window 1        │  │   Window 2        │
        │   [Worker]        │  │   [Supervisor]    │
        └──────────────────┘  └──────────────────┘
                    │                   │
                    ▼                   ▼
        ┌──────────────────┐  ┌──────────────────┐
        │  worker-wrapper   │  │ session-monitor   │
        │                   │  │                   │
        │  ┌─────────────┐ │  │  ┌─────────────┐ │
        │  │ Claude Code │ │  │  │  File Watch │ │
        │  └─────────────┘ │  │  └─────────────┘ │
        │         │         │  │         │         │
        │         ▼         │  │         ▼         │
        │   Write Session   │  │   Read Session    │
        └──────────────────┘  └──────────────────┘
                    │                   │
                    ▼                   ▼
        ┌──────────────────────────────────────┐
        │     .super/worker-session.log        │
        │   [实时写入]          [轮询读取]      │
        └──────────────────────────────────────┘

时序流程:
1. 用户 → Worker: 输入任务
2. Claude → Session Log: 写入操作记录
3. Monitor → Session Log: 每100ms轮询
4. Monitor: 检测到完成模式
5. Monitor → Tests: 运行测试验证
6. Monitor → Inquiries: 生成智能提问
7. Supervisor → 用户: 显示验证结果
```

### 优点
- 完全解耦，Worker 和 Supervisor 独立运行
- 可以随时启动/停止 Supervisor
- 保留完整会话历史供后续分析
- 不影响 Claude Code 原生行为

### 缺点
- 需要手动启动两个窗口
- 基于轮询，有延迟（100ms-1s）
- 需要解析日志识别模式（可能误判）
- 文件 I/O 开销

---

## 方案二：Hooks 方案（双 Claude 验证）

```ascii
┌─────────────────────────────────────────────────────────────┐
│                     开发者视角                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌──────────────────────────────────────┐
        │     Worker Claude (主Claude)         │
        │                                       │
        │  用户 ←→ Claude (正常交互)            │
        └──────────────────────────────────────┘
                    │
                    ▼
        ┌──────────────────────────────────────┐
        │         Claude Code 内部             │
        │                                       │
        │  任务执行 → 完成 → 继续执行          │
        │            │                          │
        │            ▼                          │
        │    [Stop Hook 触发]                  │
        └──────────────────────────────────────┘
                    │
                    ▼
        ┌──────────────────────────────────────┐
        │      stop.sh (验证触发器)            │
        │                                       │
        │  1. 检查 CLAUDE_VERIFIER_MODE       │
        │  2. 收集上下文（最近修改文件）        │
        │  3. 启动 Verifier Claude             │
        └──────────────────────────────────────┘
                    │
                    ▼
        ┌──────────────────────────────────────┐
        │   Verifier Claude (验证Claude)       │
        │     claude -p 模式                    │
        │                                       │
        │  1. 接收验证提示                     │
        │  2. 分析代码质量                     │
        │  3. 检查任务完成度                   │
        │  4. 返回验证结果                     │
        └──────────────────────────────────────┘
                    │
                    ▼
        ┌──────────────────────────────────────┐
        │      返回给 Worker Claude            │
        │                                       │
        │  📋 验证 Claude 反馈:                │
        │     - 验证结果（通过/失败）          │
        │     - 问题列表（如有）               │
        │     - 改进建议                       │
        └──────────────────────────────────────┘

触发时机:
• 用户输入任务 → Worker Claude 执行
• Worker Claude 完成任务 → [Stop Hook 触发] → Verifier Claude 验证
• 验证结果返回 → Worker Claude 显示给用户
• 用户按 ESC 中断 → [Stop Hook 不触发] → 无验证（正确行为）
• 文件修改 → [PostToolUse Hook] → 快速语法检查
```

### 优点
- 单窗口操作，用户体验简单
- 智能验证：使用 Claude 理解任务，不依赖固定模式
- 精准触发时机（仅在任务完成时，ESC中断不触发）
- 双 Claude 协作：Worker 专注执行，Verifier 专注验证
- 原生集成，稳定可靠
- claude -p 模式快速返回结果（30秒内）

### 缺点
- 需要配置项目级 .claude/settings.json
- 验证会消耗额外的 Claude API 调用
- 依赖 Claude Code 的 Hook 机制

---

## 方案三：Session 文件监控方案

```ascii
┌─────────────────────────────────────────────────────────────┐
│                     开发者视角                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌──────────────────────────────────────┐
        │         Claude Code CLI               │
        │                                       │
        │    用户 ←→ Claude (正常交互)          │
        └──────────────────────────────────────┘
                              │
                              ▼
        ┌──────────────────────────────────────┐
        │   ~/.claude/project/{session-id}/    │
        │                                       │
        │   ├── messages.jsonl  [对话历史]     │
        │   ├── tools.jsonl     [工具调用]     │
        │   └── state.json      [会话状态]     │
        └──────────────────────────────────────┘
                              ▲
                              │
                    ┌─────────┴─────────┐
                    │   文件系统监控     │
                    │   (fswatch/inotify)│
                    └───────────────────┘
                              ▲
                              │
        ┌──────────────────────────────────────┐
        │      supervisor-daemon                │
        │                                       │
        │  1. 监控 session 文件变化            │
        │  2. 解析 JSONL 格式数据              │
        │  3. 检测任务完成模式                  │
        │  4. 触发验证和测试                    │
        │  5. 生成报告(另存)                    │
        └──────────────────────────────────────┘

后台守护进程模式:
• Supervisor 作为守护进程运行
• 自动检测新 session 创建
• 实时监控所有 Claude 会话
• 验证结果写入独立日志文件
• 用户可随时查看验证报告
```

### 优点
- 完全透明，不影响 Claude 交互
- 可以监控所有历史会话
- 结构化数据（JSONL），解析准确
- 可实现高级分析（跨会话学习）

### 缺点
- 需要了解 Claude 内部文件格式
- 文件格式可能变化（版本依赖）
- 需要持续运行守护进程
- 复杂度最高

---

## 方案对比表

| 特性 | 双窗口监控 | 双Claude Hooks | Session监控 |
|------|-----------|---------------|-------------|
| **用户体验** | 需要两个窗口 | 单窗口 | 完全透明 |
| **实时性** | 100ms延迟 | 实时 | 实时 |
| **准确性** | 模式匹配 | Claude智能理解 | 结构化数据 |
| **验证质量** | 固定规则 | 自然语言理解 | 固定规则 |
| **性能开销** | 文件轮询 | API调用 | 文件监控 |
| **实现复杂度** | 中等 | 简单 | 复杂 |
| **可靠性** | 中等 | 高 | 取决于格式稳定性 |
| **维护成本** | 低 | 最低 | 高 |
| **扩展性** | 中等 | 高（Claude能力） | 最高 |
| **ESC处理** | 会误触发 | 正确跳过 | 会误触发 |

---

## 推荐方案（基于最新理解）

### 核心理念转变
**ESC 中断 = 用户主动控制，不是错误**
- 用户按 ESC 是为了接管控制，不需要验证
- 只有 Claude 认为"完成"的任务才需要验证
- Stop hook 不在 ESC 时触发，这是特性而非缺陷

### 当前实现：**双 Claude 智能验证方案** ⭐
```json
{
  "hooks": {
    "Stop": ".claude/hooks/stop.sh",
    "PostToolUse": {
      "Write": ".claude/hooks/post-tool-use.sh",
      "Edit": ".claude/hooks/post-tool-use.sh",
      "MultiEdit": ".claude/hooks/post-tool-use.sh"
    },
    "UserPromptSubmit": ".claude/hooks/user-prompt-submit.sh"
  }
}
```

**核心实现**：
1. **Stop Hook** → 启动 Verifier Claude（claude -p 模式）
2. **Verifier Claude** 智能分析：
   - 检查语法正确性
   - 评估任务完成度
   - 提供改进建议
3. **结果返回** → Worker Claude 显示给用户
4. **防循环机制** → CLAUDE_VERIFIER_MODE 环境变量

**优势**：
1. 智能验证：Claude 理解上下文，不依赖固定模式
2. ESC 正确处理：中断时不触发验证
3. 快速响应：claude -p 模式 30秒内返回
4. 参数继承：Verifier 使用相同的 Claude 参数

### 长期（高级功能）：**混合方案**
- 使用 Hooks 进行实时验证（主路径）
- 使用 Session 监控进行历史分析和学习
- 提供可选的双窗口监控模式用于调试

---

## 验证哲学：什么需要验证，什么不需要

### ✅ 需要验证的场景
1. **Claude 说"完成了"**（Stop hook 触发）
   - 验证：任务是否真的完成
   - 验证：代码是否能运行
   - 验证：测试是否通过

2. **Claude 创建/修改文件**（PostToolUse 触发）
   - 验证：语法是否正确
   - 验证：是否引入明显错误

3. **Claude 执行重要操作**
   - 验证：数据库迁移是否成功
   - 验证：部署是否正常

### ❌ 不需要验证的场景
1. **用户按 ESC 中断**
   - 原因：用户主动控制，知道自己在做什么
   - 响应：记录但不验证

2. **部分完成的任务**
   - 原因：用户可能改变主意
   - 响应：保持现状，等待新指令

3. **用户快速切换任务**
   - 原因：探索性工作的正常模式
   - 响应：跟随用户节奏

### 🎯 核心原则
**验证是为了帮助，不是监督**
- 当 Claude 认为完成时，帮用户确认质量
- 当用户接管时，退到后台不干扰
- 验证结果是建议，不是强制

---

## 实施建议

### 第一阶段：基础 Hooks（专注完成验证）
1. 实现 Stop hook - 仅在 Claude 完成任务时验证
2. PostToolUse hooks - 快速语法检查
3. UserPromptSubmit - 记录用户意图

### 第二阶段：智能验证
1. Stop hook 中根据任务类型选择验证策略
2. 构建"完成标准"库（什么算真正完成）
3. 智能判断是否需要深度验证

### 第三阶段：用户意图学习
1. 分析 UserPromptSubmit 日志理解用户模式
2. ESC 后的新指令分析（用户为什么中断）
3. 优化验证策略，减少不必要的检查

---

## 实际部署步骤

使用双 Claude 验证系统：

```bash
# 1. 克隆项目到任意位置
git clone https://github.com/yourusername/supervisor-me-mvp.git ~/supervisor-me

# 2. 进入你的项目目录
cd your-project

# 3. 复制验证系统文件
cp -r ~/supervisor-me/.claude .
cp -r ~/supervisor-me/lib .

# 4. 确保脚本有执行权限
chmod +x .claude/hooks/*.sh

# 5. 启动 Claude Code（hooks 在启动时加载）
claude
# 或带参数
claude --dangerously-skip-permissions

# 6. 正常使用，验证会自动运行
# 示例：
# 你: "创建一个计算器函数"
# Worker Claude: [创建代码...]
# Worker Claude: ✨ 完成！
# 
# [自动触发验证]
# 📋 验证 Claude 反馈: 代码语法正确，功能实现完整
```

## 核心文件说明

```yaml
.claude/settings.json:
  - 项目级 hooks 配置
  - 映射 hooks 到脚本文件

.claude/hooks/stop.sh:
  - Stop hook 处理脚本
  - 检查环境变量防止循环
  - 调用 claude-verify-simple.js

lib/claude-verify-simple.js:
  - 双 Claude 验证器核心
  - 使用 claude -p 模式
  - 收集上下文并构建提示
  - 解析并返回验证结果

其他支持文件:
  - quick-check.js: 语法快速检查
  - inquiry-generator.js: 智能问题生成
  - project-analyzer.js: 项目结构分析
```

这样实现了真正的智能验证，让编程更可靠！